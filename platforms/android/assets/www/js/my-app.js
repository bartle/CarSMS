var myApp=new Framework7({pushState:!0,swipePanel:'left',material:!0});var mainView=myApp.addView('.view-main');var $$=Dom7;var my_latitude=0;var my_longitude=0;var my_speed=0;function getAndroidVersion(ua){ua=(ua||navigator.userAgent).toLowerCase();var match=ua.match(/android\s([0-9\.]*)/);return match?match[1]:!1};function noti(text,sec){if(sec==undefined)sec=5000;myApp.addNotification({message:text,button:{text:'Закрыть'},hold:sec})}
function addZero(i){if(i<10){i="0"+i}
return i}
function timeConverter(UNIX_timestamp,day_t){var a=new Date(UNIX_timestamp*1000);var year=a.getFullYear();var month=a.getMonth();var day=a.getDate();var hour=addZero(a.getHours());var min=addZero(a.getMinutes());var sec=addZero(a.getSeconds());month++;month=(month==10||month==11||month==12)?month:"0"+month;day=(day>=9)?day:"0"+day;var date=new Date()
new_date=(date.getDate()+'.'+(date.getMonth()+1)+'.'+date.getFullYear());if((day+'.'+month+'.'+year)==new_date){day_t='Сегодня'}else if(((day+1)+'.'+month+'.'+year)==new_date){day_t='Вчера'}else{day_t=day+'.'+month+'.'+year}
if((day+'.'+month+'.'+year)==new_date){return day_t+' '+hour+':'+min}else if(((day+1)+'.'+month+'.'+year)==new_date){return day_t+' '+hour+':'+min}else{return day_t+' '+hour+':'+min}}
$$(window).on('load',function(){if(parseFloat(getAndroidVersion())<5||getAndroidVersion()==!1){myApp.alert('Версия вашей ОС не соответствует требованиям приложения. Обновите версию Android или используйте другое устройство.','Ошибка совместимости!');navigator.app.exitApp()}else{setTimeout(function(){mainView.router.reloadPage('index.html')},2500)}
setTimeout(function(){mainView.router.reloadPage('car.html')},3000);$$('.view').addClass('theme-orange')});myApp.onPageInit('set',function(page){$$('.set input[name="n1"]').val(window.localStorage.getItem("n1"));$$('.set input[name="n2"]').val(window.localStorage.getItem("n2"));$$('.set input[name="n3"]').val(window.localStorage.getItem("n3"));$$(".set option[value='"+window.localStorage.getItem("time")+"']").val(window.localStorage.getItem("time")).attr("selected",!0);$$('.save').on('click',function(){var formData=myApp.formToJSON('#set-form');console.log(formData);window.localStorage.setItem("n1",formData.n1);window.localStorage.setItem("n2",formData.n2);window.localStorage.setItem("n3",formData.n3);window.localStorage.setItem("time",formData.time);noti('Настройки сохранены!');mainView.router.reloadPage('car.html')})});myApp.onPageInit('car',function(page){$$('.click_go').on('click',function(){go()})});var timeFormat=(function(){function num(val){val=Math.floor(val);return val<10?'0'+val:val}
return function(ms){var sec=ms/1000,hours=sec/3600%24,minutes=sec/60%60,seconds=sec%60;return num(hours)+":"+num(minutes)+":"+num(seconds)}})();function startTimer(val){go_time--;var t=window.localStorage.getItem("time")*60*1000;var i=Number(t)+Number(window.localStorage.getItem("time_s"));$$('.sms_status').html("Отправка СМС через: "+timeFormat(i-Math.round(new Date().getTime()/1000.0)));if(go_time==0){}}
document.addEventListener('deviceready',function(){onDeviceReady2()},!1);function go(){if($$('.play').html()=="play_arrow"){$$('.go_status').html("Мы едем!");$$('.play').html("stop");$$('.sms_status').html("<span style=\"color: #5ca903\"><b>Таймер отправки СМС работает.<b></span>")}else{$$('.go_status').html("Мы стоим.");$$('.play').html("play_arrow");$$('.sms_status').html("SMS не отправляются!")}}
var eventCallback=function(){send_sms()}
var successCallback=function(){noti("Таймер запущен!")}
var errorCallback=function(e){alert("errorCallback")}
function startBackgroundTimer(){var settings={timerInterval:(window.localStorage.getItem("time")*1000*60),startOnBoot:!0,stopOnTerminate:!1,isForeground:!0,hours:-1,minutes:-1,}
window.BackgroundTimer.onTimerEvent(eventCallback);window.BackgroundTimer.start(successCallback,errorCallback,settings)}
function send_sms(){if($$('.play').html()=="play_arrow")return 0;noti("Координаты Определены");go_time=window.localStorage.getItem("time")*60;var i='https://maps.yandex.ru/?text='+my_latitude.toFixed(6)+'+'+my_longitude.toFixed(6);var message='Я тут: '+i;var options={replaceLineBreaks:!1,android:{intent:''}};var success=function(){noti('Сообщение успешно отправлено!');var t="window.open(encodeURI('"+'https://maps.yandex.ru/?text='+my_latitude+'+'+my_longitude+"'), '_blank', 'location=yes');";var card='<a onclick="'+t+'" href=""><div class="block block-inset"><p>'+timeConverter(Math.round(new Date().getTime()/1000.0),!0)+' Скорость: '+(my_speed*3.6).toFixed(1)+' Гео положение: '+my_latitude+' '+my_longitude+'</p></div></a>';$$('.car .cards_geo').prepend(card)};var error=function(e){noti('Message Failed:');var t="window.open(encodeURI('"+i+"'), '_blank', 'location=yes');";var card='<a onclick="'+t+'" href=""><div class="block block-inset" style="background: #f5734a;"><p>'+timeConverter(Math.round(new Date().getTime()/1000.0),!0)+' ОШИБКА [Message Failed] [Попытка повтора отправки] Гео положение: '+my_latitude+' '+my_longitude+'</p></div></a>';$$('.car .cards_geo').prepend(card);setTimeout(function(){send_sms()},15000)};var i=0;var arr=[];noti('Отправка сообщения...');if(window.localStorage.getItem("n1")!=''){sms.send(window.localStorage.getItem("n1"),message,options,success,error)}
if(window.localStorage.getItem("n2")!=''){sms.send(window.localStorage.getItem("n2"),message,options,success,error)}
if(window.localStorage.getItem("n3")!=''){sms.send(window.localStorage.getItem("n3"),message,options,success,error)}}